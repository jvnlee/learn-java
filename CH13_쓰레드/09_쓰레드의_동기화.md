# ì“°ë ˆë“œì˜ ë™ê¸°í™”

ë©€í‹° ì“°ë ˆë“œ í”„ë¡œì„¸ìŠ¤ì—ì„œëŠ” ì—¬ëŸ¬ ì“°ë ˆë“œê°€ í”„ë¡œì„¸ìŠ¤ì˜ ìì›ì„ ê³µìœ í•´ì„œ ì‘ì—…í•˜ê¸° ë•Œë¬¸ì— ì„œë¡œì˜ ì‘ì—…ì— ì˜í–¥ì„ ë¼ì¹˜ê²Œ ë¨.

ê³µìœ  ë°ì´í„°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì½”ë“œ ì˜ì—­ì„ <b>ì„ê³„ ì˜ì—­(critical section)</b>ì´ë¼ê³  í•˜ê³ ,

ì„ê³„ ì˜ì—­ì˜ ì½”ë“œë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆëŠ” ê¶Œí•œì„ <b>lock</b>ì´ë¼ê³  í‘œí˜„í•¨.

> lockì„ ê°€ì§„ ì“°ë ˆë“œë§Œì´ ì„ê³„ ì˜ì—­ì—ì„œ ì‘ì—…ì„ í•  ìˆ˜ ìˆìŒ
>
> ì‘ì—…ì´ ëë‚˜ë©´ lockì„ ë°˜ë‚©í•´ì•¼í•˜ê³ , lockì„ íšë“í•œ ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ì„ê³„ ì˜ì—­ì˜ ì½”ë“œë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆê²Œ ë¨.

&nbsp;

ì´ë ‡ê²Œ í•œ ì“°ë ˆë“œê°€ ì§„í–‰ ì¤‘ì¸ ì‘ì—…ì„ ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ê°„ì„­í•˜ì§€ ëª»í•˜ê²Œ ë§‰ëŠ” ê²ƒì„ ì“°ë ˆë“œì˜ <b>ë™ê¸°í™”(synchronization)</b>ì´ë¼ê³  í•¨.

&nbsp;

## synchronizedë¥¼ ì´ìš©í•œ ë™ê¸°í™”

`synchronized` í‚¤ì›Œë“œëŠ” ì„ê³„ ì˜ì—­ì„ ì„¤ì •í•˜ëŠ” ë°ì— ì‚¬ìš©.

1. synchronized ë©”ì„œë“œ

   ë©”ì„œë“œ ì „ì²´ë¥¼ ì„ê³„ ì˜ì—­ìœ¼ë¡œ ì„¤ì •

   ```java
   public synchronized void sum() {
       // ì„ê³„ ì˜ì—­
   }
   ```

&nbsp;

2. synchronized ë¸”ëŸ­

   ë©”ì„œë“œ ë‚´ë¶€ì˜ íŠ¹ì • ë¶€ë¶„ë§Œ ì„ê³„ ì˜ì—­ìœ¼ë¡œ ì„¤ì •

   ```java
   synchronized(ê°ì²´ì˜ ì°¸ì¡° ë³€ìˆ˜) {
       // ì„ê³„ ì˜ì—­
   }
   ```

   > ê°ì²´ì˜ ì°¸ì¡° ë³€ìˆ˜ëŠ” lockì„ ê±¸ê³ ìí•˜ëŠ” ê°ì²´ë¥¼ ì°¸ì¡°

&nbsp;

```java
class SynchronizedExample {
    public static void main(String[] args) {
        Runnable r1 = new R1();
        new Thread(r1).start();
        new Thread(r1).start();
        // ì”ê³  1000ì›ì´ ë“¤ì–´ìˆëŠ” ê³„ì¢Œë¥¼ ê³µìœ í•˜ê³  ìˆëŠ” ë‘ ì“°ë ˆë“œë¥¼ ìƒì„±í•˜ì—¬ ì‹¤í–‰ì‹œí‚´
    }
}

class Account {
    private int balance = 1000;

    public int getBalance() {
        return balance;
    }

    public void withdraw(int amount) {
        if (balance >= amount) {
            try {
                Thread.sleep(1000);
            } catch (InterruptedException e) {}

            balance -= amount;
        }
    }
}

class R1 implements Runnable {
    Account acc = new Account();

    @Override
    public void run() {
        while (acc.getBalance() > 0) {
            int money = (int)(Math.random() * 3 + 1) * 100;
            acc.withdraw(money); // ì”ê³ ê°€ 0ì›ì´ ë˜ê¸° ì „ê¹Œì§€ 100, 200, 300ì› ì¤‘ ëœë¤í•œ ê¸ˆì•¡ì„ ì¸ì¶œ
            System.out.println("Current balance: " + acc.getBalance());
        }
    }
}
```

ì‹¤í–‰ ê²°ê³¼)

    Current balance: 900
    Current balance: 900
    Current balance: 700
    Current balance: 600
    Current balance: 400
    Current balance: 300
    Current balance: 100
    Current balance: -200

`withdraw()` ë©”ì„œë“œì—ì„œ ë°œìƒí•˜ëŠ” ë™ê¸°í™” ë¬¸ì œ ë•Œë¬¸ì— ì”ê³ ê°€ ìŒìˆ˜ê°€ ë˜ëŠ” ë¬¸ì œ ë°œìƒ.

ì”ê³ ê°€ 300ì› ë‚¨ì€ ìƒíƒœì—ì„œ 1ë²ˆ ì“°ë ˆë“œê°€ 200ì›ì„ ì¸ì¶œí•˜ë ¤ê³ í•¨. ê·¸ëŸ°ë° `if`ë¬¸ ì¡°ê±´ì‹ì„ í†µê³¼í•œ ì§í›„ì— 2ë²ˆ ì“°ë ˆë“œì—ê²Œ ì œì–´ê¶Œì´ ë„˜ì–´ê°”ë‹¤ê³  ê°€ì •.

2ë²ˆì€ 300ì›ì„ ì¸ì¶œí•˜ë ¤ í–ˆê³ , ì •ìƒì ìœ¼ë¡œ ì¸ì¶œí•˜ì—¬ ì”ê³ ê°€ 0ì›ì´ ë¨. ë‹¤ì‹œ 1ë²ˆì—ê²Œ ì œì–´ê¶Œì´ ëŒì•„ì™€ ì¡°ê±´ì‹ ì´í›„ì˜ ì¸ì¶œ ì‘ì—…ì„ ìˆ˜í–‰í•˜ë©´ ì”ê³ ê°€ -200ì›ì´ ë˜ì–´ë²„ë¦¼.

&nbsp;

`if`ë¬¸ ì „ì²´ë¥¼ ì„ê³„ ì˜ì—­ìœ¼ë¡œ ë§Œë“¤ì–´ì•¼ì§€ ìœ„ì™€ ê°™ì€ ì‚¬ê³ ê°€ ë°©ì§€ë¨.

```java
public void withdraw(int amount) {
    synchronized(this) {
        if (balance >= amount) {
            ...
        }
    }
}
```

ê·¸ëŸ°ë° ì´ ê²½ìš°ì—ëŠ” ë©”ì„œë“œì˜ ë‚´ìš©ì´ `if`ë¬¸ ë°–ì— ì—†ìœ¼ë¯€ë¡œ ì•„ì˜ˆ ë©”ì„œë“œ ìì²´ë¥¼ ì„ê³„ ì˜ì—­ìœ¼ë¡œ ë§Œë“¤ì–´ë„ ê°™ìŒ

```java
public synchronized void withdraw(int amount) {
    if (balance >= amount) {
        ...
    }
}
```

&nbsp;

## wait()ê³¼ notify()

`synchronized`ëŠ” ê³µìœ  ìì›ì„ í•œë²ˆì— í•˜ë‚˜ì˜ ì“°ë ˆë“œë§Œ ì ‘ê·¼í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” ì¥ì ì´ ìˆì§€ë§Œ,

ì´ ê³¼ì •ì—ì„œ lockì„ ë³´ìœ í•œ ì“°ë ˆë“œê°€ ë¶ˆí•„ìš”í•˜ê²Œ lockì„ ì˜¤ë˜ ê°€ì§€ê³  ìˆì§€ ì•Šë„ë¡ ì¡°ì ˆí•´ì¤„ í•„ìš”ê°€ ìˆìŒ.

&nbsp;

lockì„ ë³´ìœ í•œ ì“°ë ˆë“œê°€ ì‘ì—… ë„ì¤‘ ì–´ë– í•œ ì´ìœ ì—ì„œë“  ì§„í–‰ì´ ë¶ˆê°€ëŠ¥í•œ ìƒíƒœê°€ ë˜ë©´, `wait()`ì„ í˜¸ì¶œí•´ì„œ ë¬´ì˜ë¯¸í•˜ê²Œ ê¸°ë‹¤ë¦¬ë©° ì‹œê°„ì„ ë‚ ë¦¬ì§€ ì•Šê³  lockì„ ë°˜ë‚©.

ë‹¤ë¥¸ ì“°ë ˆë“œëŠ” ì´ lockì„ ì–»ì–´ ì‘ì—…ì„ í•˜ê²Œ ë˜ê³ , ë‚˜ì¤‘ì— ì‘ì—…ì´ ê°€ëŠ¥í•œ ìƒíƒœì¼ ë•Œ `notify()`ë¥¼ í˜¸ì¶œí•˜ë©´ ì‘ì—…ì„ ì¤‘ë‹¨í–ˆë˜ ì“°ë ˆë“œê°€ ë‹¤ì‹œ lockì„ ì–»ì„ ìˆ˜ ìˆê²Œ ë¨.

ë‹¨, `wait()`ìœ¼ë¡œ ì¸í•´ waiting poolë¡œ ë“¤ì–´ê°„ ì“°ë ˆë“œëŠ” ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆëŠ”ë°, ì´ ì¤‘ì—ì„œ ê°€ì¥ ì˜¤ë˜ ê¸°ë‹¤ë¦° ì“°ë ˆë“œê°€ ê°€ì¥ ë¨¼ì € lockì„ ì–»ëŠ”ë‹¤ëŠ” ë³´ì¥ì€ ì—†ìŒ. `notify()`ëŠ” ê°ì²´ê°€ ê°€ì§„ waiting pool ë‚´ì˜ ì„ì˜ì˜ ì“°ë ˆë“œì—ê²Œë§Œ í†µë³´ë¥¼ í•´ì¤Œ.

`notifyAll()`ì€ ê°ì²´ê°€ ê°€ì§„ waiting pool ë‚´ì˜ ëª¨ë“  ì“°ë ˆë“œì—ê²Œ í†µë³´ë¥¼ í•´ì£¼ê¸´ í•˜ì§€ë§Œ, ê·¸ë˜ë„ lockì„ ì–»ëŠ” ê±´ ê·¸ ì¤‘ ë‹¨ í•˜ë‚˜ì´ë¯€ë¡œ ë‚˜ë¨¸ì§€ëŠ” ê·¸ëŒ€ë¡œ ê¸°ë‹¤ë¦¬ëŠ” ì‹ ì„¸.

- void `wait`()
- void `wait`(long ms)
- void `wait`(long ms, int ns)

> ì‹œê°„ì„ ì§€ì •í•˜ë©´ í•´ë‹¹ ì‹œê°„ì´ ì§€ë‚œ í›„ ìë™ì ìœ¼ë¡œ `notify()` í˜¸ì¶œ

- void `notify`()
- void `notifyAll`()

> `wait()`, `notify()`, `notifyAll()`ì€ ì „ë¶€ `synchronized` ë¸”ëŸ­ ë‚´ì—ì„œë§Œ ì‚¬ìš© ê°€ëŠ¥

```java
class WaitExample {
    public static void main(String[] args) throws Exception {
        Table table = new Table(); // ê³µìœ  ê°ì²´ table

        new Thread(new Cook(table), "COOK_1").start();
        new Thread(new Customer(table, "burger"), "CUSTOMER_1").start();
        new Thread(new Customer(table, "taco"), "CUSTOMER_2").start();

        Thread.sleep(5000); // 5ì´ˆ í›„
        System.exit(0); // ëª¨ë“  ì“°ë ˆë“œ ì¢…ë£Œ
    }
}

class Customer implements Runnable {
    private Table table;
    private String dish;

    Customer(Table table, String dish) {
        this.table = table;
        this.dish = dish;
    }

    @Override
    public void run() {
        while (true) {
            try {
                Thread.sleep(10);
            } catch (InterruptedException e) {}

            String customerName = Thread.currentThread().getName();
            if (eat()) {
                System.out.println(customerName + " got a " + dish);
            } else {
                System.out.println(customerName + " failed to get a " + dish);
            }
        }
    }

    boolean eat() { return table.remove(dish); }
}

class Cook implements Runnable {
    private Table table;

    Cook(Table table) {
        this.table = table;
    }

    @Override
    public void run() {
        while (true) {
            int index = (int)(Math.random() * table.menuNum());
            table.add(table.menus[index]);

            try {
                Thread.sleep(100); // ìš”ë¦¬ì‚¬ëŠ” 0.1ì´ˆì— í•œë²ˆì”© ëœë¤ ìš”ë¦¬ë¥¼ í…Œì´ë¸”ì— ì¶”ê°€í•¨
            } catch (InterruptedException e) {}
        }
    }
}

class Table {
    String[] menus = {"burger", "burger", "taco"};
    final int MAX_DISH = 6;

    private ArrayList<String> dishes = new ArrayList<>();

    public synchronized void add(String dish) {
        if (dishes.size() >= MAX_DISH) return;
        dishes.add(dish);
        System.out.println("Dishes: " + dishes);
    }

    public boolean remove(String dish) {
        synchronized (this) {
            while (dishes.size() == 0) {
                String customerName = Thread.currentThread().getName();
                System.out.println(customerName + " is waiting...");
                try {
                    Thread.sleep(500);
                    // ì†ë‹˜ì€ í…Œì´ë¸”ì— ìŒì‹ì´ ìƒê²¼ëŠ”ì§€ 0.5ì´ˆë§ˆë‹¤ í™•ì¸í•˜ë©° ê¸°ë‹¤ë¦¼
                } catch (InterruptedException e) {}
            }
            for (int i = 0; i < dishes.size(); i++) {
                if (dish.equals(dishes.get(i))) {
                    dishes.remove(i);
                    return true;
                }
            }
        }
        return false;
    }

    public int menuNum() { return menus.length; }
}
```

ì‹¤í–‰ ê²°ê³¼)

    Dishes: [burger]
    CUSTOMER_2 failed to get a taco
    CUSTOMER_1 got a burger
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...
    CUSTOMER_1 is waiting...

`synchronized`ë¡œ ê³µìœ  ê°ì²´ì¸ `table`ì„ ë‘ê³  ì¶©ëŒì´ ìƒê¸¸ ìˆ˜ ìˆëŠ” `add()`ì™€ `remove()` ë©”ì„œë“œë¥¼ ë™ê¸°í™”ì‹œì¼°ìŒ.

ê·¸ëŸ°ë°ë„ ìš”ë¦¬ì‚¬ê°€ í…Œì´ë¸”ì— ìš”ë¦¬ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šê³ , ì†ë‹˜ì€ ê³„ì† ê¸°ë‹¤ë¦¬ê¸°ë§Œ í•˜ê³  ìˆìŒ.

`remove()` ë‚´ì˜ `synchronized`ë¸”ëŸ­ì—ì„œ ì†ë‹˜ ì“°ë ˆë“œê°€ tableì˜ lockì„ ê³„ì†í•´ì„œ ì¥ê³  ìˆê¸° ë•Œë¬¸.

ìš”ë¦¬ì‚¬ ì“°ë ˆë“œê°€ ìš”ë¦¬ë¥¼ ì¶”ê°€í•˜ë ¤ê³  í•´ë„, ì†ë‹˜ì´ lockì„ ë†“ì§€ ì•Šì•„ì„œ tableì— ì ‘ê·¼í•  ìˆ˜ê°€ ì—†ê²Œë¨.

ì´ëŸ° ë¹„ì •ìƒì ì¸ ìƒí™©ì„ `wait()`ì™€ `notify()`ë¥¼ ì‚¬ìš©í•´ì„œ í•´ê²° ê°€ëŠ¥

```java
class WaitExample {
    public static void main(String[] args) throws Exception {
        Table table = new Table();

        new Thread(new Cook(table), "COOK_1").start();
        new Thread(new Customer(table, "burger"), "CUSTOMER_1").start();
        new Thread(new Customer(table, "taco"), "CUSTOMER_2").start();

        Thread.sleep(2000);
        System.exit(0);
    }
}

class Customer implements Runnable {
    private Table table;
    private String dish;

    Customer(Table table, String dish) {
        this.table = table;
        this.dish = dish;
    }

    @Override
    public void run() {
        while (true) {
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {}

            String customerName = Thread.currentThread().getName();
            table.remove(dish);
            System.out.println(customerName + " got a " + dish);
        }
    }
}

class Cook implements Runnable {
    private Table table;

    Cook(Table table) {
        this.table = table;
    }

    @Override
    public void run() {
        while (true) {
            int index = (int)(Math.random() * table.menuNum());
            table.add(table.menus[index]);
            try {
                Thread.sleep(150);
            } catch (InterruptedException e) {}
        }
    }
}

class Table {
    String[] menus = {"burger", "burger", "taco"};
    final int MAX_DISH = 6;

    private ArrayList<String> dishes = new ArrayList<>();

    public synchronized void add(String dish) {
        while (dishes.size() >= MAX_DISH) {
            String cookName = Thread.currentThread().getName();
            System.out.println(cookName + " is waiting because the table is full.");
            try {
                wait(); // ìš”ë¦¬ì‚¬ ì“°ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚´
                Thread.sleep(500);
            } catch (InterruptedException e) {}
        }
        dishes.add(dish);
        notify(); // ê¸°ë‹¤ë¦¬ê³  ìˆì„ ì†ë‹˜ ì“°ë ˆë“œë¥¼ ê¹¨ì›€
        System.out.println("Dishes: " + dishes);
    }

    public synchronized void remove(String dish) {
            String customerName = Thread.currentThread().getName();

            while (dishes.size() == 0) {
                System.out.println(customerName + " is waiting because there's no dish at all.");
                try {
                    wait(); // ìŒì‹ì´ ë‚˜ì˜¬ ë•Œê¹Œì§€ ì†ë‹˜ ì“°ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚´
                    Thread.sleep(500);
                } catch (InterruptedException e) {}
            }

            while (true) {
                for (int i = 0; i < dishes.size(); i++) {
                    if (dish.equals(dishes.get(i))) {
                        dishes.remove(i);
                        notify(); // ëŒ€ê¸°ì¤‘ì´ë˜ ìš”ë¦¬ì‚¬ ì“°ë ˆë“œë¥¼ ê¹¨ì›€
                        return;
                    }
                }

                try {
                    System.out.println(customerName + " is waiting because there isn't a dish he's looking for.");
                    wait(); // ì›í•˜ëŠ” ìŒì‹ì´ ì—†ëŠ” ì†ë‹˜ ì“°ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚´
                    Thread.sleep(500);
                } catch (InterruptedException e) {}
            }
    }

    public int menuNum() { return menus.length; }
}
```

<details>
    <summary>ì‹¤í–‰ ê²°ê³¼</summary>
    <pre>
Dishes: [taco]
Dishes: [taco, burger]
Dishes: [taco, burger, burger]
Dishes: [taco, burger, burger, taco]
Dishes: [taco, burger, burger, taco, burger]
Dishes: [taco, burger, burger, taco, burger, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_1 got a burger
Dishes: [taco, burger, taco, burger, burger, taco]
CUSTOMER_1 got a burger
CUSTOMER_2 got a taco
Dishes: [taco, burger, burger, taco, burger]
Dishes: [taco, burger, burger, taco, burger, taco]
COOK_1 is waiting because the table is full.
CUSTOMER_2 got a taco
CUSTOMER_1 got a burger
Dishes: [burger, taco, burger, taco, burger]
CUSTOMER_2 got a taco
CUSTOMER_1 got a burger
Dishes: [burger, taco, burger, burger]
Dishes: [burger, taco, burger, burger, burger]
Dishes: [burger, taco, burger, burger, burger, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_2 got a taco
CUSTOMER_1 got a burger
Dishes: [burger, burger, burger, burger, taco]
CUSTOMER_1 got a burger
CUSTOMER_2 got a taco
Dishes: [burger, burger, burger, burger]
Dishes: [burger, burger, burger, burger, burger]
Dishes: [burger, burger, burger, burger, burger, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_1 got a burger
CUSTOMER_2 is waiting because there isn't a dish he's looking for.
</pre>
</details>

&nbsp;

ì–´ë–¤ ì“°ë ˆë“œë“  ê¸°ë‹¤ë ¤ì•¼ í•˜ëŠ” ìƒí™©ì—ëŠ” `wait()`ìœ¼ë¡œ lockì„ ë°˜ë‚©í•œ ì±„ë¡œ ëŒ€ê¸°í•˜ë„ë¡ í•˜ê³ , ë‹¤ì‹œ ì‘ì—…ì„ í•´ì•¼í•  ìƒí™©ì—ëŠ” `notify()`ë¡œ ê¹¨ì›€.

ë¬¸ì œëŠ” ê³µìœ  ê°ì²´ì¸ `table`ì˜ waiting poolì€ ë‹¹ì—°íˆ í•˜ë‚˜ì´ê¸° ë•Œë¬¸ì— ê°™ì€ waiting pool ì•ˆì— ìš”ë¦¬ì‚¬ì™€ ì†ë‹˜ì´ ëª¨ë‘ ì„ì—¬ìˆë‹¤ëŠ” ì .

ê·¸ë˜ì„œ `notify()`ê°€ í˜¸ì¶œë˜ì—ˆì„ ë•Œ ëŒ€ê¸°ì¤‘ì´ë˜ ìš”ë¦¬ì‚¬ì™€ ì†ë‹˜ ì¤‘ ëˆ„ê°€ ê¹¨ì›Œì§ˆì§€ ëª¨ë¦„.

ì‹¤í–‰ ê²°ê³¼ ë§ˆì§€ë§‰ 4ì¤„ì„ ë³´ë©´, í…Œì´ë¸”ì— ìŒì‹ì´ ê°€ë“ ì°¨ì„œ ìš”ë¦¬ì‚¬ëŠ” waiting poolì— ë“¤ì–´ê°. ì†ë‹˜1ì´ ìŒì‹ì„ ê°€ì ¸ê°€ì„œ ë‹¤ì‹œ ìš”ë¦¬ë¥¼ ì‹œì‘í•´ì•¼ í•  ë•Œ, ìš”ë¦¬ì‚¬ë¥¼ ê¹¨ìš¸ ëª©ì ìœ¼ë¡œ `notify()`ë¥¼ í˜¸ì¶œí•´ë„ ìŒ©ëš± ë§ê²Œ ì†ë‹˜2ë¥¼ ê¹¨ì› ìŒ.

&nbsp;

### ê¸°ì•„ í˜„ìƒê³¼ ê²½ìŸ ìƒíƒœ

- ê¸°ì•„ í˜„ìƒ(starvation)

  ìµœì•…ì˜ ì¼€ì´ìŠ¤ì—ëŠ” ìš”ë¦¬ì‚¬ê°€ ê³„ì†í•´ì„œ í†µë³´ ë°›ì§€ ëª»í•˜ê³  waiting poolì— ê°‡í˜€ìˆì„ ìˆ˜ë„ ìˆëŠ”ë°, ì´ëŸ° ì¼€ì´ìŠ¤ë¥¼ "ê¸°ì•„ í˜„ìƒ"ì´ë¼ ë¶€ë¦„.

- ê²½ìŸ ìƒíƒœ(race condition)

  ê¸°ì•„ í˜„ìƒì„ ë§‰ê³ ì `notifyAll()`ì„ í˜¸ì¶œí•˜ë©´, ìš”ë¦¬ì‚¬ë¥¼ ê¹¨ìš°ê¸° ìœ„í•´ ì†ë‹˜ê¹Œì§€ ì „ë¶€ ë‹¤ ê¹¨ì›Œë²„ë¦¬ëŠ” ë¹„íš¨ìœ¨ì ì¸ ìƒí™©ì´ ë°œìƒí•˜ê²Œ ë¨.

  ê²Œë‹¤ê°€ í•˜ë‚˜ì˜ lockì„ ë‘ê³  ê¹¨ì–´ë‚œ ìš”ë¦¬ì‚¬ì™€ ì†ë‹˜ì´ ëª¨ë‘ ê²½ìŸì„ í•˜ê²Œ ë˜ëŠ”ë°, ì´ë¥¼ "ê²½ìŸ ìƒíƒœ"ë¼ê³  ë¶€ë¦„.

  > ë”°ë¼ì„œ ìš”ë¦¬ì‚¬ì™€ ì†ë‹˜ì„ êµ¬ë¶„í•´ì„œ ê¹¨ìš¸ ì¥ì¹˜ê°€ í•„ìš”í•¨.
  >
  > `Lock`ê³¼ `Condition`ì„ í™œìš©í•˜ë©´ ëŒ€ê¸° ì¤‘ì¸ ì“°ë ˆë“œë¥¼ ì„ ë³„ì ìœ¼ë¡œ ê¹¨ìš¸ ìˆ˜ ìˆìŒ

&nbsp;

## Lockê³¼ Conditionì„ ì´ìš©í•œ ë™ê¸°í™”

`JDK` 1.5ë¶€í„°ëŠ” `synchronized` ì™¸ì—ë„ `java.util.concurrent.locks` íŒ¨í‚¤ì§€ ë‚´ì˜ `lock` ê´€ë ¨ í´ë˜ìŠ¤ë“¤ì„ í™œìš©í•´ ë™ê¸°í™”ê°€ ê°€ëŠ¥.

`synchronized`ì˜ ì¥ì :

- ìë™ì ìœ¼ë¡œ lockì´ ê±¸ë¦¬ê±°ë‚˜ í’€ë¦¼

- ë¸”ëŸ­ ë‚´ì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ë©´ ìë™ì ìœ¼ë¡œ lockì´ í’€ë¦¼

ë‹¨ì :

- ê°™ì€ ë©”ì„œë“œ ë‚´ì—ì„œë§Œ lockì„ ê±¸ ìˆ˜ ìˆìŒ

  > ê·¸ëŸ´ ë• `synchronized` ëŒ€ì‹ ì— lock ê´€ë ¨ í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ë©´ ë¨.

&nbsp;

1. `ReentrantLock`

   ëª¨ë“  ì‘ì—…ì— ë°°íƒ€ì ì¸ lock.

   ì¬ì§„ì…ì´ ê°€ëŠ¥í•œ lock.

   > lockì„ ë°˜ë‚©í•˜ê³  waiting poolì— ê°”ë‹¤ê°€ ë‹¤ì‹œ lockì„ ì–»ì–´ ì„ê³„ì˜ì—­ìœ¼ë¡œ ëŒì•„ì™€ ì‘ì—…ì´ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì˜ë¯¸

2. `ReentrantReadWriteLock`

   ì½ê¸° ì‘ì—…ì€ ê³µìœ ì , ì“°ê¸° ì‘ì—…ì€ ë°°íƒ€ì ì¸ lock

   > ì½ê¸°ë¥¼ ìœ„í•œ lockê³¼ ì“°ê¸°ë¥¼ ìœ„í•œ lockì´ ë³„ë„ë¡œ ì¡´ì¬

   - í•œ ì“°ë ˆë“œê°€ ì½ê¸° lockì„ ê°–ê³  ìˆì–´ë„, ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ì¤‘ë³µí•´ì„œ ì½ê¸° lockì„ ì–»ì„ ìˆ˜ ìˆìŒ

   - í•œ ì“°ë ˆë“œê°€ ì“°ê¸° lockì„ ê°–ê³  ìˆìœ¼ë©´, ë‹¤ë¥¸ ì“°ë ˆë“œëŠ” ì¤‘ë³µí•´ì„œ ì“°ê¸° lockì„ ì–»ì„ ìˆ˜ ì—†ìŒ

   - ì½ê¸° lockì„ ê°€ì§„ ìƒíƒœë¡œ ì“°ê¸° lockì„ ê±°ëŠ” ê²ƒ, ë˜ëŠ” ë°˜ëŒ€ì˜ ê²½ìš° ëª¨ë‘ í—ˆìš© ì•ˆë¨.

3. `StampedLock`

   `ReentrantReadWriteLock`ì— ë‚™ê´€ì ì¸ ì½ê¸° lock ê¸°ëŠ¥ì„ ì¶”ê°€í•œ ê²ƒ

   lockì„ ê±¸ê±°ë‚˜ í’€ ë•Œ ìŠ¤íƒ¬í”„ë¥¼ ì‚¬ìš©

   (`JDK` 1.8ë¶€í„° ì¶”ê°€ë¨)

   > ë‚™ê´€ì ì´ë¼ëŠ” ê²ƒì€ ì¼ë‹¨ ë‚´ê°€ ì½ê¸°ë¥¼ ì‹œë„í•  ë•Œ, ì•„ë¬´ë„ ì´ ìˆœê°„ì— ë‚´ê°€ ì½ìœ¼ë ¤ëŠ” ë°ì´í„°ì— ì“°ê¸° ì‘ì—…ì„ í•˜ì§€ ì•Šì„ ê²ƒì´ë¼ëŠ” ë‚™ê´€ì ì¸ ê°€ì •ì„ í•œë‹¤ëŠ” ì˜ë¯¸.

   1ë²ˆ ì“°ë ˆë“œê°€ ì½ê¸° ì‘ì—…ì„ ìœ„í•´ ë‚™ê´€ì ì¸ ì½ê¸° lockì„ ê±¸ì—ˆì„ ë•Œ, 2ë²ˆ ì“°ë ˆë“œì˜ ì“°ê¸° lockì´ ê°ì§€ë˜ë©´ ì¦‰ì‹œ ë‚™ê´€ì ì¸ ì½ê¸° lockì„ í’€ì–´ë²„ë¦¼.

   ë‚™ê´€ì ì¸ ì½ê¸° lockì„ ìƒì€ 1ë²ˆ ì“°ë ˆë“œëŠ” ë‹¤ì‹œ ì½ê¸° lockì„ ì–»ê¸° ìœ„í•´ ê¸°ë‹¤ë¦¬ê³ , 2ë²ˆ ì“°ë ˆë“œì˜ ì“°ê¸° ì‘ì—…ì´ ëë‚œ ë‹¤ìŒì—ì•¼ ì½ê¸° lockì„ ì–»ìŒ.

   > ë§Œì•½ ë‚™ê´€ì ì¸ ì½ê¸° lockì„ ê±¸ì—ˆì„ ë•Œ ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ì“°ê¸° lockì„ ê±¸ì§€ ì•ŠëŠ”ë‹¤ë©´ ê·¸ëŒ€ë¡œ ì½ê¸° ì‘ì—…ì„ í•¨.

&nbsp;

### ReentrantLockì˜ ìƒì„±ì

1. `ReentrantLock`()

2. `ReentrantLock`(boolean fair)

   fairì— `true`ë¥¼ ëŒ€ì…í•´ì„œ ìƒì„±í•˜ë©´, lockì´ í’€ë ¸ì„ ë•Œ ê°€ì¥ ì˜¤ë˜ ê¸°ë‹¤ë¦° ì“°ë ˆë“œì—ê²Œ lockì„ ì¤Œ.

   > ëˆ„ê°€ ê°€ì¥ ì˜¤ë˜ ê¸°ë‹¤ë ¸ëŠ”ì§€ í™•ì¸ì´ í•„ìš”í•˜ë¯€ë¡œ ì„±ëŠ¥ì€ ë–¨ì–´ì§.

ëŒ€ë¶€ë¶„ì˜ ìƒí™©ì—ì„œëŠ” ê³µì •ì„±ì´ ì¤‘ìš”í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì„±ëŠ¥ìƒì˜ ì´ì ì´ ìˆëŠ” 1ë²ˆ ìƒì„±ìë¥¼ ì‚¬ìš©

&nbsp;

lock ê´€ë ¨ í´ë˜ìŠ¤ë“¤ì€ ìˆ˜ë™ìœ¼ë¡œ lockì„ ê±¸ê±°ë‚˜ í•´ì œí•´ì•¼í•¨

- void `lock`()

  lockì„ ê²€

- void `unlock`()

  lockì„ í’ˆ

- boolean `isLocked`()

  í˜„ì¬ lockì´ ê±¸ë ¤ìˆëŠ”ì§€ í™•ì¸í•¨

&nbsp;

ì„ê³„ ì˜ì—­ ì•ˆì—ì„œ ì˜ˆì™¸ê°€ ë°œìƒí•˜ê±°ë‚˜ `return`ë¬¸ìœ¼ë¡œ ì„ê³„ ì˜ì—­ì„ ë¹ ì ¸ë‚˜ê°€ë©´ lockì´ í’€ë¦¬ì§€ ì•Šì„ ìˆ˜ ìˆê¸° ë•Œë¬¸ì— `unlock()`ì€ `try-finally`ë¬¸ìœ¼ë¡œ ê°ì‹¸ì¤Œ.

```java
ReentrantLock lock = new ReentrantLock();
lock.lock();

try {
    // ì„ê³„ ì˜ì—­
} finally {
    lock.unlock();
}
```

`lock()`ì€ í˜¸ì¶œ ë‹¹ì‹œì— ë‹¤ë¥¸ ì“°ë ˆë“œì—ê²Œ lockì´ ìˆìœ¼ë©´ ë°˜ë‚©ì´ ë˜ì–´ ìì‹ ì´ ì‚¬ìš©í•  ìˆ˜ ìˆì„ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¼.

> ê¸°ë‹¤ë¦¬ëŠ” ë™ì•ˆ ì“°ë ˆë“œë¥¼ block ì‹œí‚¤ê¸° ë•Œë¬¸ì— ì‘ë‹µì„±ì´ ë–¨ì–´ì§

ì´ ê¸°ë‹¤ë¦¼ì„ ì›ì¹˜ ì•Šê±°ë‚˜ ì¼ì • ì‹œê°„ ë§Œí¼ë§Œ ê¸°ë‹¤ë¦¬ê¸° ì›í•˜ë©´ `tryLock()` ì‚¬ìš©

- boolean `tryLock`()

- boolean `tryLock`(long timeout, TimeUnit unit) throws InterruptedException

  > ì§€ì •ëœ ì‹œê°„ ë™ì•ˆ ê¸°ë‹¤ë¦´ ë•Œ, `interrupt()`ì— ì˜í•´ ê¸°ë‹¤ë¦¼ì„ ì·¨ì†Œí•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ì˜ˆì™¸ê°€ ë¶™ìŒ

&nbsp;

### ReentrantLockê³¼ Condition

waiting poolì— ë„£ê±°ë‚˜ ê¹¨ìš¸ ë•Œ í†µë³´ ëŒ€ìƒì„ ëª…í™•íˆ êµ¬ë¶„í•˜ê¸° ìœ„í•´ `Condition`ì„ ì‚¬ìš©

ì• ì´ˆì— waiting poolì— ë„£ì„ ë•Œ êµ¬ë¶„ë  í•„ìš”ê°€ ìˆëŠ” ì“°ë ˆë“œë¥¼ ìœ„í•´ ê°œë³„ `Condition`ì„ ë§Œë“¤ë©´ ë³„ë„ì˜ waiting pool ì•ˆì— ë„£ì„ ìˆ˜ ìˆìŒ.

`Condition`ì€ lockìœ¼ë¡œë¶€í„° ìƒì„± ê°€ëŠ¥

```java
private ReentrantLock lock = new ReentrantLock();

private Condition cookCondition = lock.newCondition();
private Condition customerCondition = lock.newCondition();
```

`wait()` ëŒ€ì‹  `await()`, `notify()` ëŒ€ì‹  `signal()`ì„ ì‚¬ìš©í•˜ì—¬ waiting poolë¡œ ë„£ê±°ë‚˜, ê¹¨ìš¸ ìˆ˜ ìˆìŒ.

```java
class WaitExample {
    public static void main(String[] args) throws Exception {
        Table table = new Table();

        new Thread(new Cook(table), "COOK_1").start();
        new Thread(new Customer(table, "burger"), "CUSTOMER_1").start();
        new Thread(new Customer(table, "taco"), "CUSTOMER_2").start();

        Thread.sleep(2000);
        System.exit(0);
    }
}

class Customer implements Runnable {
    private Table table;
    private String dish;

    Customer(Table table, String dish) {
        this.table = table;
        this.dish = dish;
    }

    @Override
    public void run() {
        while (true) {
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {}

            String customerName = Thread.currentThread().getName();
            table.remove(dish);
            System.out.println(customerName + " got a " + dish);
        }
    }
}

class Cook implements Runnable {
    private Table table;

    Cook(Table table) {
        this.table = table;
    }

    @Override
    public void run() {
        while (true) {
            int index = (int)(Math.random() * table.menuNum());
            table.add(table.menus[index]);
            try {
                Thread.sleep(10);
            } catch (InterruptedException e) {}
        }
    }
}

class Table {
    String[] menus = {"burger", "burger", "taco"};
    final int MAX_DISH = 6;
    private ArrayList<String> dishes = new ArrayList<>();

    private ReentrantLock lock = new ReentrantLock();
    private Condition customerCondition = lock.newCondition();
    private Condition cookCondition = lock.newCondition();

    public void add(String dish) {
        lock.lock(); // ê³µìœ ìì›ì¸ tableì— lockì„ ê²€
        try {
            while (dishes.size() >= MAX_DISH) {
                String cookName = Thread.currentThread().getName();
                System.out.println(cookName + " is waiting because the table is full.");
                try {
                    cookCondition.await(); // ìš”ë¦¬ì‚¬ ì“°ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚´
                    Thread.sleep(500);
                } catch (InterruptedException e) {}
            }
            dishes.add(dish);
            customerCondition.signal(); // ê¸°ë‹¤ë¦¬ê³  ìˆì„ ì†ë‹˜ ì“°ë ˆë“œë¥¼ ê¹¨ì›€
            System.out.println("Dishes: " + dishes);
        } finally {
            lock.unlock(); // ë°˜ë“œì‹œ lockì„ í’€ì–´ì¤˜ì•¼í•¨
        }
    }

    public void remove(String dish) {
            lock.lock(); // ê³µìœ  ìì›ì¸ tableì— lockì„ ê²€
            String customerName = Thread.currentThread().getName();

            try {
                while (dishes.size() == 0) {
                    System.out.println(customerName + " is waiting because there's no dish at all.");
                    try {
                        customerCondition.await(); // ìŒì‹ì´ ë‚˜ì˜¬ ë•Œê¹Œì§€ ì†ë‹˜ ì“°ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚´
                        Thread.sleep(500);
                    } catch (InterruptedException e) {}
                }

                while (true) {
                    for (int i = 0; i < dishes.size(); i++) {
                        if (dish.equals(dishes.get(i))) {
                            dishes.remove(i);
                            cookCondition.signal(); // ëŒ€ê¸°ì¤‘ì´ë˜ ìš”ë¦¬ì‚¬ ì“°ë ˆë“œë¥¼ ê¹¨ì›€
                            return;
                        }
                    }

                    try {
                        System.out.println(customerName + " is waiting because there isn't a dish he's looking for.");
                        customerCondition.await(); // ì›í•˜ëŠ” ìŒì‹ì´ ì—†ëŠ” ì†ë‹˜ ì“°ë ˆë“œë¥¼ ëŒ€ê¸°ì‹œí‚´
                        Thread.sleep(500);
                    } catch (InterruptedException e) {}
                }
            } finally {
                lock.unlock();
            }
    }

    public int menuNum() { return menus.length; }
}
```

<details>
    <summary>ì‹¤í–‰ ê²°ê³¼</summary>
    <pre>
Dishes: [taco]
Dishes: [taco, taco]
Dishes: [taco, taco, taco]
Dishes: [taco, taco, taco, burger]
Dishes: [taco, taco, taco, burger, taco]
Dishes: [taco, taco, taco, burger, taco, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_2 got a taco
Dishes: [taco, taco, burger, taco, burger, taco]
CUSTOMER_1 got a burger
CUSTOMER_2 got a taco
Dishes: [taco, taco, burger, taco, burger]
Dishes: [taco, taco, burger, taco, burger, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_2 got a taco
CUSTOMER_1 got a burger
Dishes: [taco, taco, burger, burger, burger]
CUSTOMER_1 got a burger
CUSTOMER_2 got a taco
Dishes: [taco, burger, burger, taco]
Dishes: [taco, burger, burger, taco, burger]
Dishes: [taco, burger, burger, taco, burger, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_1 got a burger
CUSTOMER_2 got a taco
Dishes: [burger, taco, burger, burger, burger]
CUSTOMER_1 got a burger
CUSTOMER_2 got a taco
Dishes: [burger, burger, burger, burger]
Dishes: [burger, burger, burger, burger, burger]
Dishes: [burger, burger, burger, burger, burger, burger]
COOK_1 is waiting because the table is full.
CUSTOMER_1 got a burger
CUSTOMER_2 is waiting because there isn't a dish he's looking for.
    </pre>
</details>

&nbsp;

ì´ì „ì˜ ì˜ˆì œì—ì„œ `synchronized`ë¥¼ ë¹¼ê³ , `ReentrantLock`ê³¼ `Condition`ìœ¼ë¡œ ëŒ€ì²´í•¨.

ì „ê³¼ ë‹¬ë¦¬ ê¹¨ìš¸ ì“°ë ˆë“œë¥¼ íŠ¹ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìš”ë¦¬ì‚¬ë¥¼ ê¹¨ìš°ë ¤ë‹¤ê°€ ì†ë‹˜ì„ ê¹¨ìš°ëŠ” ë¶ˆìƒì‚¬ëŠ” ì¼ì–´ë‚˜ì§€ ì•ŠìŒ.

ì„œë¡œ ë‹¤ë¥¸ ì¢…ë¥˜ì˜ ì“°ë ˆë“œ ê°„ì˜ ê¸°ì•„ í˜„ìƒê³¼ ê²½ìŸ ìƒíƒœëŠ” ê°œì„ ë˜ì—ˆìœ¼ë‚˜, ì—¬ì „íˆ ê°™ì€ ì¢…ë¥˜ì˜ ì“°ë ˆë“œ(ì†ë‹˜)ë¼ë¦¬ëŠ” ê¸°ì•„ í˜„ìƒê³¼ ê²½ìŸ ìƒíƒœê°€ ë°œìƒí•  ìˆ˜ ìˆìŒ.

ì´ëŠ” burgerë¥¼ ì›í•˜ëŠ” ì†ë‹˜ê³¼ tacoë¥¼ ì›í•˜ëŠ” ì†ë‹˜ì„ êµ¬ë¶„í•˜ê¸° ìœ„í•´ ë³„ë„ì˜ ì†ë‹˜ Conditionì„ ìƒì„±í•´ì„œ í•´ê²°í•  ìˆ˜ ìˆìŒ.

&nbsp;

## volatile

CPU ì½”ì–´ëŠ” ë©”ëª¨ë¦¬ì—ì„œ ì½ì–´ì˜¨ ê°’ì„ ìºì‹œì— ì €ì¥í•˜ê³ , ìºì‹œì— ì €ì¥ëœ ê°’ì„ ì½ì–´ì„œ ì‘ì—…í•¨.

ë‹¤ì‹œ ê°™ì€ ê°’ì„ ì½ì–´ì˜¬ ì¼ì´ ìˆì„ ë•Œì—ëŠ” ìºì‹œë¥¼ ë¨¼ì € í™•ì¸í•˜ê³  ì—†ìœ¼ë©´ ë©”ëª¨ë¦¬ì—ì„œ ì½ì–´ì˜´.

&nbsp;

ë§Œì•½ ë©”ëª¨ë¦¬ì— ì €ì¥ëœ ê°’ì´ ë°”ë€Œì—ˆëŠ”ë°, ì½”ì–´ê°€ ì—¬ì „íˆ ìºì‹œì— ì €ì¥ëœ ë‚¡ì€ ê°’ì„ ì°¸ì¡°í•˜ë©´ ë¬¸ì œê°€ ë°œìƒí•¨.

`volatile` í‚¤ì›Œë“œë¥¼ ì‚¬ìš©í•˜ë©´ ìºì‹œê°€ ì•„ë‹Œ ë©”ëª¨ë¦¬ì—ì„œ ê°’ì„ ì½ì–´ì˜¤ë„ë¡ ë§Œë“¤ì–´ ì´ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŒ.

> `synchronized`ë¥¼ ì‚¬ìš©í•´ë„ ê°™ì€ íš¨ê³¼ê°€ ìˆìŒ
>
> ì“°ë ˆë“œê°€ `synchronized` ë¸”ëŸ­ ì•ˆì— ë“¤ì–´ê°€ê±°ë‚˜ ë‚˜ì˜¬ ë•Œ ë©”ëª¨ë¦¬ì™€ ìºì‹œ ê°„ì˜ ë™ê¸°í™”ê°€ ì´ë£¨ì–´ì§€ê¸° ë•Œë¬¸.

```java
volatile boolean isOn = false;
```

&nbsp;

### volatileë¡œ longê³¼ doubleì„ ì›ìí™”

`JVM`ì€ ë°ì´í„°ë¥¼ 4 byte ë‹¨ìœ„ë¡œ ì²˜ë¦¬í•¨

ë”°ë¼ì„œ 4 byte ì´í•˜ì˜ ë²”ìœ„ì— ìˆëŠ” ë°ì´í„°(`int`ì™€ ê·¸ ì•„ë˜)ë¥¼ ê°€ì§€ê³  ì‘ì—…í•  ë•ŒëŠ” í•˜ë‚˜ì˜ ëª…ë ¹ì–´(ì‘ì—…ì˜ ìµœì†Œ ë‹¨ìœ„)ë¡œ ì²˜ë¦¬ ê°€ëŠ¥. (ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ë¼ì–´ë“¤ ì—¼ë ¤ê°€ ì—†ìŒ)

&nbsp;

ê·¸ëŸ¬ë‚˜ 4 byte ë³´ë‹¤ í° íƒ€ì…ì˜ ë°ì´í„°(`long`, `double`)ë¥¼ ë‹¤ë£° ë•Œì—ëŠ” í•˜ë‚˜ì˜ ëª…ë ¹ì–´ë¡œ ì²˜ë¦¬ê°€ ë¶ˆê°€í•˜ë¯€ë¡œ ì‘ì—… ë„ì¤‘ì— ë‹¤ë¥¸ ì“°ë ˆë“œê°€ ë¼ì–´ë“¤ ìˆ˜ ìˆìŒ

ì´ ë•Œ `volatile`ì„ ì‚¬ìš©í•˜ë©´ 4 byte ì´ìƒì˜ í¬ê¸°ë¥¼ ê°€ì§„ ë°ì´í„°ë„ ì›ìí™”í•´ì„œ ì´ ë¬¸ì œë¥¼ ë°©ì§€í•  ìˆ˜ ìˆìŒ.

> **ì›ìí™”**: ì‘ì—…ì„ ë” ì´ìƒ ë‚˜ëˆŒ ìˆ˜ ì—†ê²Œ í•œë‹¤ëŠ” ëœ»

> ğŸ“Œ [ì£¼ì˜] ìƒìˆ˜ì—ëŠ” `volatile` ì‚¬ìš© ë¶ˆê°€.
>
> ì• ì´ˆì— ë³€í•  ê°’ì´ ì•„ë‹ˆê¸° ë•Œë¬¸ì— ë‹¤ë¥¸ ì“°ë ˆë“œì˜ ë¼ì–´ë“¤ê¸°ë¥¼ êµ³ì´ ë°©ì§€í•  í•„ìš”ê°€ ì—†ìŒ.

&nbsp;

`volatile`ì´ ì½ê¸°/ì“°ê¸°ë¥¼ ì›ìí™”í•˜ê³ , ë°ì´í„°ë¥¼ ë©”ëª¨ë¦¬ë¡œë¶€í„° ì°¸ì¡°í•˜ê²Œë” ê°•ì œí•œë‹¤ê³  í•´ì„œ ë™ê¸°í™”ë¥¼ ë³´ì¥í•´ì£¼ì§€ëŠ” ì•ŠìŒ. (ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ì“°ê¸° ì‘ì—…ì„ í•  ìˆ˜ ìˆëŠ” ìƒí™© ë“±)

> ì˜¤ì§ 1ê°œì˜ ì“°ë ˆë“œë§Œ ì½ê¸°/ì“°ê¸°ê°€ ê°€ëŠ¥í•˜ê³ , ë‚˜ë¨¸ì§€ ì“°ë ˆë“œëŠ” ì½ê¸°ë§Œ ê°€ëŠ¥í•œ ìƒí™©ì´ë¼ë©´ `volatile` ë§Œìœ¼ë¡œë„ ë™ê¸°í™” ìƒíƒœ ìœ ì§€ ê°€ëŠ¥

ë”°ë¼ì„œ `volatile`ì´ ë¶™ì€ ë³€ìˆ˜ë¥¼ í™œìš©í•  ë•Œ, `synchronized`ë¥¼ ì ì ˆíˆ ì‚¬ìš©í•´ ë™ê¸°í™”ë¥¼ ì‹œì¼œì¤˜ì•¼í•¨.

```java
volatile long counter;

synchronized int getBalance() {
    return balance; // ì”ê³  ê°’ ë°˜í™˜ (ì½ê¸°)
}

synchronized void withdraw(int amount) {
    if (balance >= amount) {
        balance -= amount; // ì”ê³ ì—ì„œ íŠ¹ì • ê¸ˆì•¡ë§Œí¼ ì°¨ê° (ì“°ê¸°)
    }
}
```

ë§Œì•½ `getBalance()`ì— `synchronized`ë¥¼ ë¶™ì´ì§€ ì•ŠëŠ”ë‹¤ë©´, `withdraw()`ê°€ í˜¸ì¶œë˜ì–´ ì¸ì¶œí•˜ê³  ìˆëŠ” ë„ì¤‘ì—ë„ `getBalance()`ë¥¼ í˜¸ì¶œí•˜ëŠ” ê²ƒì´ ê°€ëŠ¥í•´ì ¸ ë™ê¸°í™”ê°€ ì•ˆë¨.

&nbsp;

## fork & join í”„ë ˆì„ì›

í•˜ë‚˜ì˜ ì‘ì—…ì„ ì‘ì€ ë‹¨ìœ„ë¡œ ë‚˜ëˆ ì„œ ì—¬ëŸ¬ ì“°ë ˆë“œê°€ ë™ì‹œì— ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ ë§Œë“¤ì–´ì¤Œ.

`JDK` 1.7ë¶€í„° ì¶”ê°€ë¨

&nbsp;

ì‘ì—…ì˜ ì¢…ë¥˜ì— ë”°ë¼ 2ê°€ì§€ í´ë˜ìŠ¤ ì¤‘ í•˜ë‚˜ë¥¼ ìƒì†ë°›ì•„ êµ¬í˜„

- `RecursiveAction`: ë°˜í™˜ê°’ì´ ì—†ëŠ” ì‘ì—…ì„ êµ¬í˜„í•  ë•Œ

- `RecursiveTask`: ë°˜í™˜ê°’ì´ ìˆëŠ” ì‘ì—…ì„ êµ¬í˜„í•  ë•Œ

&nbsp;

2ê°€ì§€ ëª¨ë‘ `compute()`ë¼ëŠ” ì¶”ìƒë©”ì„œë“œë¥¼ ê°–ê³  ìˆëŠ”ë°, ìƒì† í›„ ì´ ë©”ì„œë“œë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒì´ í•µì‹¬

ex)

```java
class SumTask extends RecursiveTask<Long> {
    long from, to;

    SumTask(long from, long to) {
        this.from = from;
        this.to = to;
    }

    public Long compute() {
        // ...ìˆ˜í–‰í•  ì‘ì—…ì˜ ë‚´ìš©ìœ¼ë¡œ êµ¬í˜„
    }
}
```

&nbsp;

ê·¸ë¦¬ê³  ë‚˜ì„œ ì“°ë ˆë“œí’€ê³¼ ì‘ì—… ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•˜ê³ , `invoke()`ë¡œ ì‘ì—…ì„ ê°œì‹œí•¨.

> `Thread`ë¥¼ ì‹œì‘í•  ë•Œ `run()`ì´ ì•„ë‹Œ `start()`ì„ ì“°ë“¯ì´, fork & join í”„ë ˆì„ì›ìœ¼ë¡œ ìˆ˜í–‰í•  ì‘ì—…ë„ `compute()`ê°€ ì•„ë‹Œ `invoke()`ë¡œ ì‹œì‘

```java
ForkJoinPool pool = new ForkJoinPool();
SumTask task = new SumTask();

Long result = pool.invoke(task);
```

`ForkJoinPool`

- fork & join í”„ë ˆì„ì›ì—ì„œ ì œê³µí•˜ëŠ” thread pool.

- ì§€ì •ëœ ìˆ˜ì˜ ì“°ë ˆë“œ(ì½”ì–´ì™€ ë™ì¼í•œ ê°œìˆ˜)ë¥¼ ìƒì„±í•´ë†“ê³ , ê³„ì†í•´ì„œ ì¬ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ.

  > ì“°ë ˆë“œë¥¼ ê³„ì† ìƒì„±í•´ì£¼ì§€ ì•Šì•„ë„ ë˜ê³ , ê³¼ë‹¤í•œ ì“°ë ˆë“œ ìƒì„±ìœ¼ë¡œ ì„±ëŠ¥ì´ ì €í•˜ë˜ëŠ” ë¬¸ì œë¥¼ ë°©ì§€í•´ì¤Œ.

- ì“°ë ˆë“œê°€ ìˆ˜í–‰í•  ì‘ì—…ì´ ë‹´ê¸´ queueë¥¼ ì œê³µ

  > ê° ì“°ë ˆë“œëŠ” ìì‹ ì˜ ì‘ì—… queueì— ìˆëŠ” ì‘ì—…ì„ ìˆœì„œëŒ€ë¡œ ì²˜ë¦¬

&nbsp;

### compute()ì˜ êµ¬í˜„

ìˆ˜í–‰í•  ì‘ì—…ì˜ ë‚´ìš©ê³¼ í•¨ê»˜ ì‘ì—…ì„ ì–´ë–»ê²Œ ì‘ê²Œ ìª¼ê°¤ ê²ƒì¸ì§€ë„ ì •í•´ì•¼í•¨.

ex) 1ë¶€í„° nê¹Œì§€ì˜ ì •ìˆ˜ í•©ì„ êµ¬í•˜ëŠ” ì‘ì—…

> `from`ë¶€í„° `to`ê¹Œì§€ì˜ í•©ì„ êµ¬í•˜ëŠ” `sum`(long from, long to) ë©”ì„œë“œê°€ ë”°ë¡œ ì¡´ì¬í•œë‹¤ê³  ê°€ì •.

```java
public Long compute() {
    long size = to - from + 1;

    if (size <= 5) {
        return sum(); // ìª¼ê°œê³  ìª¼ê°œë‹¤ê°€ ë”í•´ì•¼í•  ìˆ˜ê°€ 5ê°œ ì´í•˜ê°€ ë˜ë©´ ë”í•´ì„œ ê²°ê³¼ë¥¼ ë°˜í™˜
    }

    long half = (from + to) / 2;

    SumTask leftSum = new SumTask(from, half);
    SumTask rightSum = new SumTask(half + 1, to);

    leftSum.fork(); // ì‘ì—… íì— ë„£ìŒ

    return rightSum.compute() + leftSum.join();
}
```

ì£¼ì–´ì§„ ë²”ìœ„ë¥¼ ë°˜ìœ¼ë¡œ ìª¼ê°  ë‹¤ìŒ

ì¢Œì¸¡ ì ˆë°˜ì€ ì‘ì—… íì— ë„£ê³ , ìš°ì¸¡ ì ˆë°˜ì€ ì´ ìª¼ê°œê¸° ì‘ì—…ì„ ì¬ê·€ì ìœ¼ë¡œ ê³„ì†í•˜ê²Œ ë§Œë“¦. (`size`ê°€ 5 ì´í•˜ê°€ ë  ë•Œê¹Œì§€)

&nbsp;

### ë‹¤ë¥¸ ì“°ë ˆë“œì˜ ì‘ì—… í›”ì³ì˜¤ê¸°

`fork()`ê°€ í˜¸ì¶œë˜ì–´ ì‘ì—… íì— ì¶”ê°€ëœ ì‘ì—… ë˜í•œ `compute()`ì— ì˜í•´ ë” ì´ìƒ ìª¼ê°œì§ˆ ìˆ˜ ì—†ì„ ë•Œê¹Œì§€ ë°˜ë³µí•´ì„œ ìª¼ê°œì§€ê³ ,

ì‘ì—… íê°€ ë¹„ì–´ìˆëŠ” ì“°ë ˆë“œëŠ” ì´ ê³¼ì •ì—ì„œ ë‹¤ë¥¸ ì“°ë ˆë“œì˜ ì‘ì—… íì—ì„œ ì‘ì—…ì„ ê°€ì ¸ì™€ ìˆ˜í–‰í•¨. ì´ë¥¼ <b>ì‘ì—… í›”ì³ì˜¤ê¸°(work stealing)</b>ë¼ê³  ë¶€ë¦„.

&nbsp;

### fork()ì™€ join()

`fork()`: ì‘ì—…ì„ ì“°ë ˆë“œì˜ ì‘ì—… íì— ë„£ìŒ (ë¹„ë™ê¸° ë©”ì„œë“œ)

`join()`: ì‘ì—… ìˆ˜í–‰ì´ ëë‚  ë•Œê¹Œì§€ ê¸°ë‹¤ë ¸ë‹¤ê°€ ê²°ê³¼ë¥¼ ë°˜í™˜í•¨ (ë™ê¸° ë©”ì„œë“œ)

> ë¹„ë™ê¸° ë©”ì„œë“œëŠ” í˜¸ì¶œ í›„ ê²°ê³¼ë¥¼ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ë‹¤ìŒ ë¬¸ì¥ìœ¼ë¡œ ë„˜ì–´ê°.

&nbsp;

```java
class ForkJoinExample {
    static final ForkJoinPool pool = new ForkJoinPool();

    public static void main(String[] args) {
        long from = 1L, to = 100_000_000L;

        SumTask task = new SumTask(from, to);

        long start = System.currentTimeMillis();
        Long result = pool.invoke(task);
        System.out.println("8 Core: " + (System.currentTimeMillis() - start) + "ms");
        System.out.println(result);

        result = 0L;
        start = System.currentTimeMillis();
        for (long i = from; i <= to; i++) {
            result += i;
        }
        System.out.println("1 Core: " + (System.currentTimeMillis() - start) + "ms");
        System.out.println(result);
    }
}

class SumTask extends RecursiveTask<Long> {
    long from, to;

    SumTask(long from, long to) {
        this.from = from;
        this.to = to;
    }

    public Long compute() {
        long size = to - from + 1;

        if (size <= 5) {
            return sum();
        }

        long half = (from + to) / 2;

        SumTask leftSum = new SumTask(from, half);
        SumTask rightSum = new SumTask(half + 1, to);

        leftSum.fork();

        return rightSum.compute() + leftSum.join();
    }

    long sum() {
        long tmp = 0L;

        for (long i = from; i <= to; i++) {
            tmp += i;
        }

        return tmp;
    }
}
```

ì‹¤í–‰ ê²°ê³¼)

    8 Core: 576ms
    5000000050000000
    1 Core: 304ms
    5000000050000000

8ì½”ì–´ ë©€í‹° ì“°ë ˆë“œë¡œ ëŒë¦° ì‘ì—…ì´ ë” ì˜¤ë˜ê±¸ë¦° ì´ìœ ëŠ”, `compute()`ë¡œ ì‘ì—…ì„ ìª¼ê°œê³  ë‹¤ì‹œ ê²°ê³¼ë¥¼ í•©ì¹˜ëŠ” ì‹œê°„ì´ ì¶”ê°€ì ìœ¼ë¡œ ë“¤ê¸° ë•Œë¬¸.

ì´ ê²½ìš°ì—ëŠ” ì‹±ê¸€ ì“°ë ˆë“œì—ì„œ ë‹¨ìˆœ `for`ë¬¸ìœ¼ë¡œ ì´í•©ì„ êµ¬í•˜ëŠ”ê²Œ ë” ë¹ ë¦„

ë”°ë¼ì„œ ë©€í‹° ì“°ë ˆë“œê°€ í•­ìƒ ë¹ ë¥¸ ê²ƒì€ ì•„ë‹ˆê³ , í…ŒìŠ¤íŠ¸ ê²°ê³¼ì™€ ìƒí™©ì— ë§ì¶° ì‚¬ìš©í•´ì•¼í•¨.
